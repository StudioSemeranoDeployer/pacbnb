<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PacBnb | Guest & Web3 Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --bnb-yellow: #F0B90B;
            --bg-dark: #0b0e11;
            --glass: rgba(255, 255, 255, 0.07);
            --danger: #ff4d4d;
        }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); font-family: 'Inter', sans-serif; color: white; }
        
        /* UI OVERLAYS */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .pointer { pointer-events: auto; }

        /* HEADER & STATS */
        #header { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-group { display: flex; gap: 10px; }
        .card { background: var(--glass); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .label { font-size: 9px; color: var(--bnb-yellow); text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 16px; font-weight: 800; }

        /* SCREENS */
        .screen { 
            position: absolute; inset: 0; background: rgba(11, 14, 17, 0.9); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; z-index: 1000; transition: opacity 0.3s ease;
        }
        .hidden { opacity: 0; pointer-events: none; }

        /* BUTTONS */
        .btn {
            background: var(--bnb-yellow); color: #000; border: none; padding: 14px 28px;
            font-weight: bold; border-radius: 12px; cursor: pointer; margin: 5px; font-size: 14px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-outline { background: transparent; border: 1px solid var(--bnb-yellow); color: var(--bnb-yellow); }
        
        #wallet-tag { font-size: 10px; margin-top: 5px; opacity: 0.6; }

        .signature { position: absolute; bottom: 15px; width: 100%; text-align: center; font-size: 10px; opacity: 0.4; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="header">
            <div class="stat-group">
                <div class="card">
                    <div class="label">Vite (USDC)</div>
                    <div id="ui-lives" class="value">0</div>
                </div>
                <div class="card">
                    <div class="label">Punti</div>
                    <div id="ui-score" class="value">0</div>
                </div>
            </div>
            <div class="card pointer" id="wallet-info" onclick="connectWallet()">
                <div class="label" id="wallet-status">Wallet</div>
                <div id="wallet-addr" class="value" style="font-size: 12px;">Connetti</div>
            </div>
        </div>
        <div class="signature">APULIANCHAIN - PACBNB DAPP</div>
    </div>

    <div id="start-screen" class="screen">
        <h1 style="color: var(--bnb-yellow); font-size: 40px; margin: 0;">PacBnb</h1>
        <p style="opacity: 0.6; margin-bottom: 30px;">Web3 Gaming & High Liquidity</p>
        <div style="display: flex; flex-direction: column; width: 220px;">
            <button class="btn pointer" onclick="startGuestMode()">PLAY AS GUEST</button>
            <button class="btn btn-outline pointer" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
        <div id="wallet-tag">Connetti per usare USDC come vite</div>
    </div>

    <div id="over-screen" class="screen hidden">
        <h2 style="color: var(--danger); font-size: 30px;">MARGIN CALL</h2>
        <div class="card" style="margin-bottom: 20px;">
            <div class="label">Final Score</div>
            <div id="final-score" class="value" style="font-size: 24px;">0</div>
        </div>
        <button class="btn pointer" onclick="location.reload()">TRY AGAIN</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- STATE & WEB3 ---
        let lives = 0, score = 0, isRunning = false, isDemo = true;
        let provider, signer, account;

        const updateUI = () => {
            document.getElementById('ui-lives').innerText = lives;
            document.getElementById('ui-score').innerText = score;
        };

        window.startGuestMode = () => {
            lives = 3; 
            isDemo = true;
            updateUI();
            document.getElementById('start-screen').classList.add('hidden');
            isRunning = true;
            if(audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.connectWallet = async () => {
            if (window.ethereum) {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    account = await signer.getAddress();
                    document.getElementById('wallet-addr').innerText = account.substring(0,6) + "...";
                    document.getElementById('wallet-status').innerText = "Connesso";
                    
                    // Se connetti, ti diamo un bonus o carichiamo il saldo
                    isDemo = false;
                    lives = 5; // Placeholder per saldo reale USDC
                    updateUI();
                    document.getElementById('start-screen').classList.add('hidden');
                    isRunning = true;
                } catch (err) { console.log("User rejected"); }
            } else { alert("MetaMask non trovato"); }
        };

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSfx = (f, t) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = t; o.frequency.value = f;
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.1);
        };

        // --- THREE.JS SCENE ---
        const TILE = 10;
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0b0e11);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambient);

        // Player (BNB)
        const player = new THREE.Mesh(
            new THREE.SphereGeometry(3, 32, 32),
            new THREE.MeshStandardMaterial({ color: 0xF0B90B, metalness: 0.6, roughness: 0.2 })
        );
        player.position.set(0, 3, 0);
        scene.add(player);

        // Map (Simplified for performance)
        const walls = [];
        const mapData = [
            [1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,1],
            [1,0,1,0,0,0,1,0,1],
            [1,0,0,0,1,0,0,0,1],
            [1,1,1,1,1,1,1,1,1]
        ];

        mapData.forEach((row, z) => {
            row.forEach((val, x) => {
                const pos = [(x - 4) * TILE, 0, (z - 2) * TILE];
                if(val === 1) {
                    const wall = new THREE.Mesh(new THREE.BoxGeometry(TILE, 6, TILE), new THREE.MeshStandardMaterial({ color: 0x1e2329 }));
                    wall.position.set(pos[0], 3, pos[2]);
                    scene.add(wall);
                    walls.push(new THREE.Box3().setFromObject(wall));
                }
            });
        });

        camera.position.set(0, 80, 40);
        camera.lookAt(0, 0, 0);

        // --- GAMEPLAY ENGINE ---
        let moveDir = { x: 0, z: 0 };
        const keys = {};

        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        // Mobile Touch Fix
        window.addEventListener('touchstart', e => {
            const tx = e.touches[0].clientX;
            const ty = e.touches[0].clientY;
            const w = window.innerWidth;
            const h = window.innerHeight;
            if(ty < h*0.3) moveDir = {x:0, z:-1};
            else if(ty > h*0.7) moveDir = {x:0, z:1};
            else if(tx < w*0.5) moveDir = {x:-1, z:0};
            else moveDir = {x:1, z:0};
        });

        function checkCollision(newPos) {
            const playerBox = new THREE.Box3().setFromCenterAndSize(newPos, new THREE.Vector3(5,5,5));
            for(let wall of walls) {
                if(playerBox.intersectsBox(wall)) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isRunning) return;

            // Input Keyboard
            if(keys['ArrowUp'] || keys['w']) moveDir = {x:0, z:-1};
            if(keys['ArrowDown'] || keys['s']) moveDir = {x:0, z:1};
            if(keys['ArrowLeft'] || keys['a']) moveDir = {x:-1, z:0};
            if(keys['ArrowRight'] || keys['d']) moveDir = {x:1, z:0};

            const nextPos = player.position.clone().add(new THREE.Vector3(moveDir.x * 0.6, 0, moveDir.z * 0.6));
            
            if(!checkCollision(nextPos)) {
                player.position.copy(nextPos);
                // Estetica rotazione
                player.rotation.x += moveDir.z * 0.15;
                player.rotation.z -= moveDir.x * 0.15;
            }

            // Punteggio casuale (Demo)
            if(Math.random() > 0.99) {
                score += 10;
                playSfx(440, 'sine');
                updateUI();
            }

            // Simulazione Pericolo
            if(Math.random() > 0.999) {
                lives--;
                playSfx(110, 'sawtooth');
                updateUI();
                if(lives <= 0) {
                    isRunning = false;
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('over-screen').classList.remove('hidden');
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
