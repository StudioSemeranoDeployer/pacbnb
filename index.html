<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PacBnb | ApulianChain Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --bnb-yellow: #F0B90B;
            --bg-dark: #05070a;
            --glass: rgba(20, 20, 25, 0.85);
        }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); font-family: 'Inter', sans-serif; color: white; user-select: none; }
        
        /* UI HUD */
        #hud {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            display: flex; justify-content: space-between; align-items: flex-start; z-index: 100;
            pointer-events: none;
        }
        .stat-card {
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(240, 185, 11, 0.3);
            pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .label { font-size: 10px; color: var(--bnb-yellow); text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        .value { font-size: 22px; font-weight: 900; }

        #web3-btn {
            background: var(--bnb-yellow); color: black; border: none; padding: 12px 24px;
            font-weight: 900; border-radius: 8px; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 20px rgba(240, 185, 11, 0.3); transition: 0.3s;
        }

        /* SCREENS */
        .overlay {
            position: absolute; inset: 0; background: radial-gradient(circle, #0b0e11 0%, #05070a 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; text-align: center;
        }
        .hidden { display: none !important; }
        
        .btn-main {
            background: var(--bnb-yellow); color: black; border: none; padding: 18px 50px;
            font-size: 18px; font-weight: 900; border-radius: 12px; cursor: pointer;
            margin-top: 20px; box-shadow: 0 0 30px rgba(240, 185, 11, 0.4);
        }

        /* FOOTER BRANDS */
        #footer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 70px;
            display: flex; justify-content: center; align-items: center; gap: 40px;
            z-index: 100; background: linear-gradient(to top, black, transparent);
        }
        .brand { font-size: 11px; font-weight: 700; letter-spacing: 2px; opacity: 0.7; color: #fff; }
        .brand span { color: var(--bnb-yellow); }
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-card">
            <div class="label">Earned</div>
            <div id="score-val" class="value">0.00 BNB</div>
        </div>
        <button id="web3-btn" onclick="connectWallet()">CONNECT WALLET</button>
    </div>

    <div id="start-screen" class="overlay">
        <svg width="80" height="80" viewBox="0 0 100 100" fill="var(--bnb-yellow)" style="margin-bottom:20px;">
            <path d="M50 35L35 50l15 15 15-15-15-15zm0-24L18 43l12 12 20-20 20 20 12-12L50 11zm0 78L18 57l12-12 20 20 20-20 12 12L50 89z"/>
        </svg>
        <h1 style="font-size: 50px; margin: 0; letter-spacing: 10px;">PACBNB</h1>
        <p style="opacity: 0.5; letter-spacing: 3px;">BY APULIANCHAIN</p>
        <button class="btn-main" onclick="startGame()">START TRADING</button>
    </div>

    <div id="footer">
        <div class="brand"><span>APULIAN</span>CHAIN</div>
        <div class="brand"><span>BINANCE</span> SMART CHAIN</div>
        <div class="brand">CRYPTO<span>START</span></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let score = 0, isRunning = false;
        const TILE = 12;
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x05070a);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 2.5; // FIX OSCURITÀ: Esposizione alta
        document.body.appendChild(renderer.domElement);

        // --- ILLUMINAZIONE POTENZIATA ---
        const ambient = new THREE.AmbientLight(0xffffff, 1.2); 
        scene.add(ambient);
        
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 2.0);
        scene.add(hemi);

        const point = new THREE.PointLight(0xF0B90B, 3000, 100);
        point.position.set(0, 50, 0);
        scene.add(point);

        // --- MAPPA & ASSETS ---
        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const walls = [], coins = [], ghosts = [];
        let player, playerDir = new THREE.Vector3(0,0,0), nextDir = new THREE.Vector3(0,0,0);

        function initLevel() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x1a1d21, metalness: 0.8, roughness: 0.2 });
            const coinMat = new THREE.MeshStandardMaterial({ 
                color: 0x00f2ff, emissive: 0x00f2ff, emissiveIntensity: 3.0 
            });

            map.forEach((row, z) => {
                row.forEach((type, x) => {
                    const px = (x - 6) * TILE;
                    const pz = (z - 2) * TILE;

                    if(type === 1) {
                        const wall = new THREE.Mesh(new THREE.BoxGeometry(TILE, 8, TILE), wallMat);
                        wall.position.set(px, 4, pz);
                        scene.add(wall);
                        // Bordi luminosi per visibilità muri
                        const wire = new THREE.LineSegments(
                            new THREE.EdgesGeometry(wall.geometry),
                            new THREE.LineBasicMaterial({ color: 0x333333 })
                        );
                        wall.add(wire);
                        walls.push(new THREE.Box3().setFromObject(wall));
                    } else {
                        const coin = new THREE.Mesh(new THREE.OctahedronGeometry(1.2), coinMat);
                        coin.position.set(px, 3, pz);
                        scene.add(coin);
                        coins.push(coin);
                    }
                });
            });

            // PLAYER - BNB LOGO SPHERE
            player = new THREE.Mesh(
                new THREE.SphereGeometry(4, 32, 32),
                new THREE.MeshStandardMaterial({ color: 0xF0B90B, emissive: 0xF0B90B, emissiveIntensity: 0.5 })
            );
            player.position.set(-4 * TILE, 4, 0);
            scene.add(player);

            // GHOSTS - NEMICI NEON
            const colors = [0xff0055, 0x00ff88, 0x9945FF];
            for(let i=0; i<3; i++) {
                const g = new THREE.Mesh(
                    new THREE.CapsuleGeometry(2.5, 3, 4, 16),
                    new THREE.MeshStandardMaterial({ color: colors[i], emissive: colors[i], emissiveIntensity: 4.0 })
                );
                g.position.set(i * TILE, 4, 0);
                g.userData = { dir: new THREE.Vector3(0,0,1), speed: 0.15 + (i*0.03) };
                scene.add(g);
                ghosts.push(g);
            }

            camera.position.set(0, 120, 70);
            camera.lookAt(0,0,0);
        }

        // --- GAME ENGINE ---
        function update() {
            if(!isRunning) return;

            // Movimento Player con Collisioni
            const step = nextDir.clone().multiplyScalar(1.0);
            const testPos = player.position.clone().add(step);
            const pBox = new THREE.Box3().setFromCenterAndSize(testPos, new THREE.Vector3(7,7,7));
            
            let hit = false;
            walls.forEach(w => { if(pBox.intersectsBox(w)) hit = true; });

            if(!hit) {
                playerDir.copy(nextDir);
                player.position.copy(testPos);
            } else {
                const forward = player.position.clone().add(playerDir.clone().multiplyScalar(1.0));
                const fBox = new THREE.Box3().setFromCenterAndSize(forward, new THREE.Vector3(7,7,7));
                let blocked = false;
                walls.forEach(w => { if(fBox.intersectsBox(w)) blocked = true; });
                if(!blocked) player.position.copy(forward);
            }

            // Monete
            coins.forEach(c => {
                if(c.visible && player.position.distanceTo(c.position) < 6) {
                    c.visible = false;
                    score += 0.01;
                    document.getElementById('score-val').innerText = score.toFixed(2) + " BNB";
                }
                c.rotation.y += 0.05;
            });

            // Fantasmi AI
            ghosts.forEach(g => {
                g.position.add(g.userData.dir.clone().multiplyScalar(g.userData.speed));
                const gBox = new THREE.Box3().setFromCenterAndSize(g.position, new THREE.Vector3(9,9,9));
                walls.forEach(w => {
                    if(gBox.intersectsBox(w)) {
                        const ds = [new THREE.Vector3(1,0,0), new THREE.Vector3(-1,0,0), new THREE.Vector3(0,0,1), new THREE.Vector3(0,0,-1)];
                        g.userData.dir = ds[Math.floor(Math.random()*4)];
                    }
                });
                if(player.position.distanceTo(g.position) < 6) location.reload();
            });
        }

        // --- INPUTS ---
        window.startGame = () => {
            document.getElementById('start-screen').classList.add('hidden');
            initLevel();
            isRunning = true;
        };

        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowUp') nextDir.set(0,0,-1);
            if(e.key === 'ArrowDown') nextDir.set(0,0,1);
            if(e.key === 'ArrowLeft') nextDir.set(-1,0,0);
            if(e.key === 'ArrowRight') nextDir.set(1,0,0);
        });

        window.connectWallet = async () => {
            if(window.ethereum) {
                const p = new ethers.BrowserProvider(window.ethereum);
                const s = await p.getSigner();
                const a = await s.getAddress();
                document.getElementById('web3-btn').innerText = a.substring(0,6)+"...";
                document.getElementById('web3-btn').style.background = "#00ff88";
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
