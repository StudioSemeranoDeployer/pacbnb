<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PacBnb | ApulianChain Global</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --bnb-yellow: #F0B90B;
            --bg-dark: #05070a;
            --glass: rgba(20, 20, 25, 0.8);
            --neon-blue: #00f2ff;
        }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); font-family: 'Inter', system-ui, sans-serif; color: white; user-select: none; }
        
        /* CRT SCANLINE EFFECT */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; z-index: 50; pointer-events: none;
        }

        /* HUD SUPERIORE */
        #hud {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            display: flex; justify-content: space-between; align-items: flex-start; z-index: 100;
        }
        .stat-card {
            background: var(--glass); backdrop-filter: blur(12px);
            padding: 10px 20px; border-radius: 8px; border-left: 3px solid var(--bnb-yellow);
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        .label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .value { font-size: 20px; font-weight: 800; color: white; font-variant-numeric: tabular-nums; }
        
        /* PULSANTE WEB3 */
        .btn-connect {
            background: var(--bnb-yellow); color: black; border: none; padding: 10px 20px;
            font-weight: 800; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-size: 12px;
            box-shadow: 0 0 15px rgba(240, 185, 11, 0.4); transition: 0.3s;
        }
        .btn-connect:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(240, 185, 11, 0.6); }

        /* FOOTER BRANDING */
        #footer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
            background: linear-gradient(to top, #000 0%, transparent 100%);
            display: flex; justify-content: center; align-items: center; gap: 30px;
            z-index: 100; padding-bottom: 10px; opacity: 0.8;
        }
        .brand { font-size: 10px; font-weight: 600; letter-spacing: 2px; color: #555; display: flex; align-items: center; gap: 6px; }
        .brand span { color: var(--bnb-yellow); }
        .brand.highlight { color: white; }

        /* SCREENS */
        .overlay {
            position: absolute; inset: 0; background: rgba(5, 7, 10, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; text-align: center; transition: opacity 0.5s;
        }
        .title-glitch { font-size: 48px; font-weight: 900; color: var(--bnb-yellow); text-shadow: 2px 2px 0px #ff00de, -2px -2px 0px #00f2ff; margin-bottom: 10px; }
        .start-btn {
            background: transparent; border: 2px solid var(--bnb-yellow); color: var(--bnb-yellow);
            padding: 15px 50px; font-size: 18px; font-weight: bold; letter-spacing: 3px;
            margin-top: 30px; cursor: pointer; transition: 0.3s;
        }
        .start-btn:hover { background: var(--bnb-yellow); color: black; }
        .hidden { opacity: 0; pointer-events: none; }

    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-card">
            <div class="label">Balance (Score)</div>
            <div id="score-display" class="value">0.00 BNB</div>
        </div>
        <button id="web3-btn" class="btn-connect" onclick="connectWallet()">Connect Wallet</button>
    </div>

    <div id="start-screen" class="overlay">
        <div class="title-glitch">PACBNB</div>
        <p style="color: #888; letter-spacing: 1px;">DEFI GAMIFIED EXPERIENCE</p>
        <button class="start-btn" onclick="startGame()">INITIALIZE</button>
        <p style="font-size: 10px; color: #444; margin-top: 20px;">TOUCH TO MOVE • EAT CRYPTO • AVOID ALTS</p>
    </div>

    <div id="footer">
        <div class="brand highlight">POWERED BY <span>APULIANCHAIN</span></div>
        <div style="width: 1px; height: 15px; background: #333;"></div>
        <div class="brand"><span>BINANCE</span> SMART CHAIN</div>
        <div style="width: 1px; height: 15px; background: #333;"></div>
        <div class="brand">CRYPTO<span>START</span></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CONFIG ---
        const TILE_SIZE = 10;
        const PLAYER_SPEED = 0.25;
        const GHOST_SPEED = 0.15;
        
        let score = 0;
        let isRunning = false;
        let animationId;

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x05070a, 0.015); // Nebbia per profondità
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING (Cruciale per la visibilità) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); // Luce base
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(20, 50, 20);
        dirLight.castShadow = true;
        scene.add(dirLight);
        
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5); // (Cielo, Terreno, Intensità)
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);
        
        // --- MAP GENERATION ---
        // 1 = Muro, 0 = Crypto (Eth/Sol/Ada), 9 = Player Start, 8 = Ghost Spawn
        const mapLayout = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,1,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,1,0,1],
            [1,0,0,0,1,8,8,8,1,0,0,0,1],
            [1,0,1,0,1,0,0,0,1,0,1,0,1],
            [1,0,1,1,1,0,1,0,1,1,1,0,1],
            [1,0,0,0,0,0,9,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const walls = [];
        const coins = [];
        const ghosts = [];
        let player;
        let nextDir = new THREE.Vector3(0, 0, 0);
        let currentDir = new THREE.Vector3(0, 0, 0);

        function createLevel() {
            const wallGeo = new THREE.BoxGeometry(TILE_SIZE, 8, TILE_SIZE);
            const wallMat = new THREE.MeshStandardMaterial({ 
                color: 0x1a1d21, roughness: 0.1, metalness: 0.5 
            });

            // Colori Crypto per le monete
            const coinColors = [0x627EEA, 0x00ff88, 0x9945FF]; // ETH Blue, Green, SOL Purple

            mapLayout.forEach((row, z) => {
                row.forEach((type, x) => {
                    const posX = (x - 6) * TILE_SIZE;
                    const posZ = (z - 4) * TILE_SIZE;

                    if (type === 1) {
                        // MURO
                        const wall = new THREE.Mesh(wallGeo, wallMat);
                        wall.position.set(posX, 4, posZ);
                        wall.castShadow = true;
                        wall.receiveShadow = true;
                        scene.add(wall);
                        // Aggiungiamo bordo neon ai muri
                        const edges = new THREE.LineSegments(
                            new THREE.EdgesGeometry(wallGeo), 
                            new THREE.LineBasicMaterial({ color: 0x333333 })
                        );
                        wall.add(edges);
                        walls.push(new THREE.Box3().setFromObject(wall));
                    } 
                    else if (type === 0 || type === 9 || type === 8) {
                        // MONETE (Anche dove spawna il player c'è spazio vuoto)
                        if (type === 0 || type === 9) {
                            const coinGeo = new THREE.DodecahedronGeometry(1.5); // Forma geometrica "Crypto"
                            const color = coinColors[Math.floor(Math.random() * coinColors.length)];
                            const coinMat = new THREE.MeshStandardMaterial({ 
                                color: color, 
                                emissive: color, 
                                emissiveIntensity: 0.8,
                                metalness: 0.8
                            });
                            const coin = new THREE.Mesh(coinGeo, coinMat);
                            coin.position.set(posX, 3, posZ);
                            scene.add(coin);
                            coins.push(coin);
                        }
                    }

                    // PLAYER SPAWN
                    if (type === 9) {
                        const playerGeo = new THREE.SphereGeometry(3.5, 32, 32);
                        const playerMat = new THREE.MeshStandardMaterial({ 
                            color: 0xF0B90B, 
                            emissive: 0xF0B90B, 
                            emissiveIntensity: 0.2,
                            metalness: 0.6, 
                            roughness: 0.2 
                        });
                        player = new THREE.Mesh(playerGeo, playerMat);
                        player.position.set(posX, 3.5, posZ);
                        
                        // Luce del giocatore (Torcia)
                        const pLight = new THREE.PointLight(0xF0B90B, 500, 40);
                        player.add(pLight);
                        
                        scene.add(player);
                    }

                    // GHOST SPAWN
                    if (type === 8) {
                        const ghostGroup = new THREE.Group();
                        // Corpo
                        const body = new THREE.Mesh(
                            new THREE.CapsuleGeometry(2.5, 3, 4, 8),
                            new THREE.MeshStandardMaterial({ color: 0xff0055, emissive: 0xff0055, emissiveIntensity: 0.6 })
                        );
                        body.position.y = 3;
                        ghostGroup.add(body);
                        // Occhi
                        const eye = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({color:0xffffff}));
                        eye.position.set(1, 4, 1.5);
                        ghostGroup.add(eye);
                        const eye2 = eye.clone();
                        eye2.position.set(-1, 4, 1.5);
                        ghostGroup.add(eye2);

                        ghostGroup.position.set(posX, 0, posZ);
                        ghostGroup.userData = { dir: new THREE.Vector3(1,0,0) };
                        ghosts.push(ghostGroup);
                        scene.add(ghostGroup);
                    }
                });
            });
            
            // Camera position
            camera.position.set(0, 110, 60);
            camera.lookAt(0, 0, 10);
        }

        // --- GAME LOGIC ---
        function update() {
            if (!isRunning) return;

            // 1. Movimento Player
            const intendedPos = player.position.clone().add(nextDir.clone().multiplyScalar(PLAYER_SPEED * TILE_SIZE));
            if (!checkWallCollision(intendedPos)) {
                currentDir.copy(nextDir);
            }
            
            const nextPos = player.position.clone().add(currentDir.clone().multiplyScalar(PLAYER_SPEED));
            if (!checkWallCollision(nextPos)) {
                player.position.copy(nextPos);
                // Rotazione estetica verso la direzione
                if(currentDir.length() > 0) {
                    player.lookAt(player.position.clone().add(currentDir));
                }
            }

            // 2. Collisione Monete
            for (let i = coins.length - 1; i >= 0; i--) {
                const coin = coins[i];
                coin.rotation.y += 0.05; // Animazione rotazione
                coin.rotation.z += 0.02;

                if (coin.visible && player.position.distanceTo(coin.position) < 5) {
                    coin.visible = false;
                    score += 0.01;
                    document.getElementById('score-display').innerText = score.toFixed(2) + " BNB";
                    // Effetto sonoro (opzionale)
                }
            }

            // 3. Nemici AI (Basic Bounce)
            ghosts.forEach(g => {
                const gNext = g.position.clone().add(g.userData.dir.clone().multiplyScalar(GHOST_SPEED));
                
                // Controllo collisione muri per fantasmi (Semplificato)
                // Se sbatte, cambia direzione a caso
                let hitWall = false;
                const gBox = new THREE.Box3().setFromCenterAndSize(gNext.clone().add(new THREE.Vector3(0,3,0)), new THREE.Vector3(6,6,6));
                for(let w of walls) {
                    if(gBox.intersectsBox(w)) hitWall = true;
                }

                if(!hitWall) {
                    g.position.copy(gNext);
                    g.lookAt(g.position.clone().add(g.userData.dir));
                } else {
                    const dirs = [new THREE.Vector3(1,0,0), new THREE.Vector3(-1,0,0), new THREE.Vector3(0,0,1), new THREE.Vector3(0,0,-1)];
                    g.userData.dir = dirs[Math.floor(Math.random()*dirs.length)];
                }

                // Kill Player
                if(player.position.distanceTo(g.position) < 5) {
                    gameOver();
                }
            });
        }

        function checkWallCollision(position) {
            // Player Box (leggermente più piccola della tile per muoversi bene)
            const pBox = new THREE.Box3().setFromCenterAndSize(position, new THREE.Vector3(6, 6, 6));
            for (const wallBox of walls) {
                if (pBox.intersectsBox(wallBox)) return true;
            }
            return false;
        }

        function gameOver() {
            isRunning = false;
            alert("LIQUIDATED! Score: " + score.toFixed(2) + " BNB");
            location.reload();
        }

        // --- CONTROLS ---
        window.addEventListener('keydown', (e) => {
            if(e.key === "ArrowUp") nextDir.set(0, 0, -1);
            if(e.key === "ArrowDown") nextDir.set(0, 0, 1);
            if(e.key === "ArrowLeft") nextDir.set(-1, 0, 0);
            if(e.key === "ArrowRight") nextDir.set(1, 0, 0);
        });

        // Touch Controls (Invisible D-PAD)
        window.addEventListener('touchstart', (e) => {
            const x = e.touches[0].clientX / window.innerWidth;
            const y = e.touches[0].clientY / window.innerHeight;
            if (y < 0.3) nextDir.set(0, 0, -1); // Up
            else if (y > 0.7) nextDir.set(0, 0, 1); // Down
            else if (x < 0.5) nextDir.set(-1, 0, 0); // Left
            else nextDir.set(1, 0, 0); // Right
        });

        // --- INIT ---
        window.startGame = () => {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('start-screen').classList.add('hidden');
                isRunning = true;
            }, 500);
        };

        window.connectWallet = async () => {
            const btn = document.getElementById('web3-btn');
            btn.innerText = "Connecting...";
            if(window.ethereum) {
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const addr = await signer.getAddress();
                    btn.innerText = addr.substring(0,6) + "..." + addr.substring(38);
                    btn.style.background = "#00ff88"; // Success green
                } catch(e) {
                    btn.innerText = "Error";
                }
            } else {
                alert("MetaMask not found!");
                btn.innerText = "Connect Wallet";
            }
        };

        // Boot
        createLevel();
        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
